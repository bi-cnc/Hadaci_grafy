
<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√°dej zemi podle HDP</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* --- Z√ÅKLADN√ç STYLY KONTEJNERU --- */
        /* --- TITULEK + PODTITULEK --- */
            /* --- Styly pro VLASTN√ç na≈°ept√°vaƒç (≈ôe≈°√≠ pozici, velikost, rolov√°n√≠) --- */
            .autocomplete-wrapper {
                position: relative; /* Kl√≠ƒçov√©: Kontejner pro input je relativn√≠ */
                flex-grow: 1;
            }

            .country-suggestions {
                position: absolute; /* Kl√≠ƒçov√©: Kontejner n√°vrh≈Ø je absolutn√≠ */
                top: 100%;          /* Zobraz√≠ se p≈ôesnƒõ pod inputem */
                left: 0;
                right: 0;
                z-index: 1000;
                
                /* Vlastn√≠ OMEZEN√ç VELIKOSTI */
                max-height: 200px; /* Nastav√≠ max. v√Ω≈°ku */
                overflow-y: auto;  /* Umo≈æn√≠ scrollov√°n√≠, kdy≈æ se p≈ôekroƒç√≠ max-height */
                
                border: 1px solid #ddd;
                border-top: none;
                background-color: #fff;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                border-radius: 0 0 4px 4px;
                display: none; /* V√Ωchoz√≠ stav: skryt√© */
            }

            .suggestion-item {
                padding: 10px 12px;
                cursor: pointer;
                font-size: 1rem;
                color: #333;
                border-bottom: 1px solid #eee;
                transition: background-color 0.1s;
            }

            .suggestion-item:last-child {
                border-bottom: none;
            }

            .suggestion-item:hover {
                background-color: #f0f0f0;
            }

            /* Zv√Ωraznƒõn√≠ shoduj√≠c√≠ se ƒç√°sti textu */
            .suggestion-item span.match {
                font-weight: 700;
                color: #1976d2;
            }

            /* Zaji≈°tƒõn√≠, ≈æe input vypln√≠ ≈°√≠≈ôku wrapperu */
            .autocomplete-wrapper input {
                width: 100%; 
                box-sizing: border-box; 
                border-radius: 4px; /* Zaji≈°tƒõn√≠ horn√≠ch kulat√Ωch roh≈Ø */
            }
            .title-wrapper {
                text-align: center;
                margin-bottom: 20px;
                animation: fadeIn 0.6s ease-out; /* jemn√Ω fade-in p≈ôi naƒçten√≠ */
            }

            .title-wrapper h2 {
                font-size: 1.8rem;
                color: #222;
                margin-bottom: 8px;
            }

            .chart-subtitle {
                font-size: 1.2rem;
                color: #666;
                font-weight: 400;
                letter-spacing: 0.3px;
                margin: 0;
            }

            /* --- ANIMACE PRO TITULEK --- */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(6px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
                .youdrawit-container {
            max-width: 660px;
            margin: 40px auto;
            padding: 0 16px;
            box-sizing: border-box;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            padding-bottom: 30px;
            /* üëá P≈òIDEJTE TOTO üëá */
            color-scheme: only light; 
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .youdrawit-container svg {
            width: 100%;
            max-width: 620px;
            height: auto;
            display: block;
            margin: 0 auto;
            min-height: 400px; 
            overflow: visible;
            background-color: #ffffff !important;
            color-scheme: only light !important;
            forced-color-adjust: none !important;
        }

        /* --- TYPOGRAFIE --- */
        .youdrawit-container h2 {
            padding-top: 20px;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8rem;
            color: #222;
        }
        .youdrawit-container .chart-title {
            text-align: center;
            font-weight: 500;
            font-size: 1.1rem;
            margin-bottom: 30px;
            color: #555;
        }
        .youdrawit-container .guess-prompt {
            text-align: center;
            font-size: 1.3rem;
            color: #2e2d2d; 
            font-weight: 700;
            margin-top: 15px;
            line-height: 1.6;
            letter-spacing: 0.4px; 
        }
        .youdrawit-container .guess-prompt .highlighted {
            background-color: #f7483b;  /* tvoje nov√° ƒçerven√° */
            color: #fff;                /* b√≠l√Ω text */
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            letter-spacing: 0.4px;   /* üîπ p≈ôid√° jemn√© rozestupy */
        }

        /* --- STYLY GRAFU (D3.JS) --- */
        .country-line {
            fill: none;
            stroke-width: 1.5;
            opacity: 0.1; 
            transition: opacity 0.3s;
        }
        .mystery-line {
            stroke: #f7483b; 
            stroke-width: 3.5;
            opacity: 1;
            fill: none; 
        }
        .guessed-line {
            stroke-width: 2.5;
            opacity: 0.9;
            fill: none;
        }
        .tick line {
            stroke: #e0e0e0;
        }
        /* --- OSA X --- */
        .x-axis .tick text {
            text-anchor: middle;
            dx: 0;
            dy: 6px; /* posune text lehce dol≈Ø pod osu */
            fill: #555;
            font-size: 16px;  /* üí• p≈ôep√≠≈°e inline atribut */
            font-weight: 500;
        }

        /* --- OSA Y --- */
        .y-axis .tick text {
            text-anchor: end;
            dx: -4px;
            fill: #010101 !important; /* üëà ZMƒöNA: Tmav≈°√≠ barva + !important */
            font-size: 16px;
            font-weight: 500;
        }
        .domain {
            stroke: #ccc;
            stroke-width: 1.5;
        }
        .y-grid line {
            stroke: #f0f0f0;
            stroke-width: 1;
        }
        .label-text {
            font-size: 13px;
            font-weight: 700;
            text-shadow: 0 0 3px #fff, 0 0 3px #fff; 
        }
        .country-dot {
            fill: currentColor;
            stroke: #fff;
            stroke-width: 2;
        }

        /* --- FORMUL√Å≈ò A TLAƒå√çTKA --- */
        .guess-form {
            display: flex;
            gap: 10px;
            max-width: 620px;
            margin: 20px auto 0 auto;
            /* padding: 0 16px;*/
        }
        .guess-form input {
            flex-grow: 1;
            /* ZV√ù≈†ENO ODSZEN√ç PRO LEP≈†√ç VIDITELNOST H√ÅƒåK≈Æ */
            padding: 14px 12px; 
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .guess-form button, #new-game-button, #new-game-button-result {
            padding: 12px 20px;
            font-size: 1rem;
            background-color: #1976d2; 
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: 120px;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .guess-form button:hover, #new-game-button:hover, #new-game-button-result:hover {
            background-color: #1565c0;
        }
        .guess-form button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
                /* --- Desktop / tablet --- */
        .select-mobile {
        display: none;
        }

/* --- Mobiln√≠ verze --- */
         @media (max-width: 700px) {
        .input-desktop {
            /* üöÄ OPRAVA: Mus√≠ se ZOBRAZIT (nap≈ô. jako blok, aby se spr√°vnƒõ renderoval s wrapperem) */
            display: block; 
            flex-grow: 1; /* Ponechat pro spr√°vn√© rozlo≈æen√≠ ve flex kontejneru */
        }

        /* 1. UPRAVTE SELECT BOX - Nyn√≠ SKR√ùV√ÅME, proto≈æe je zbyteƒçn√Ω */
        .select-mobile {
            display: none; /* ‚ùó SKRYT√ç STAR√âHO SELECTU ‚ùó */
        }

        /* 2. P≈òIDEJTE STYL PRO TLAƒå√çTKO (Ponech√°no beze zmƒõny) */
         .guess-form button {
        flex-shrink: 0;     /* Zabr√°n√≠ smr≈°tƒõn√≠ tlaƒç√≠tka */
        padding: 12px 14px;  /* Men≈°√≠ boƒçn√≠ padding */
        min-width: auto; /* Zru≈°√≠ desktopov√Ω min-width */
        }
        }

        /* --- V√ùSLEDKOV√ù BOX (Nyn√≠ slou≈æ√≠ m√≠sto mod√°lu) --- */
        #result-box {
            max-width: 620px;
            margin: 30px auto 35px auto;
            padding: 25px;
            border-radius: 8px;
            background-color: #f5f5f5;  /* svƒõtle ≈°ed√° */
            border-left: 5px solid #f4685e; /* decentn√≠ ƒçerven√Ω prou≈æek */
            display: none;
            line-height: 1.6;
            color: #333;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: 400; /* üîπ v√Ωchoz√≠: bƒõ≈æn√© p√≠smo */
        }

        /* v≈°e uvnit≈ô #result-box bez tuƒçn√©ho stylu, p≈ôep√≠≈°e dƒõdiƒçn√© styly z E15 */
        #result-box * {
            font-weight: 400 !important;
        }

        /* üîπ Nadpis a zv√Ωraznƒõn√° odpovƒõƒè z≈Øst√°vaj√≠ tuƒçn√© */
        #result-box h3,
        #result-box .correct-answer {
            font-weight: 700 !important;
        }

        #result-box h3 {
            color: #1976d2;
            margin-top: 0;
            font-size: 1.6rem; 
            text-align: center;
            margin-bottom: 15px;
        }

        .correct-answer {
            color: #f7483b; /* ƒåerven√° pro spr√°vnou odpovƒõƒè */
        }

        #result-box button {
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        /* --- Seznam tip≈Ø --- */
        #guess-list {
            max-width: 620px;
            margin: 20px auto;
            padding: 0 16px;
        }

        .guess-item {
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            font-size: 1.1rem; /* üîπ men≈°√≠ text (cca 15 px) */
        }

        .guess-item span:first-child {
            font-weight: 600;
            color: #444;
        }

        /* --- PULZUJ√çC√ç LINKA --- */
        @keyframes celebratePulse {
            0% { stroke-width: 3.5; opacity: 1; }
            50% { stroke-width: 6; opacity: 0.6; }
            100% { stroke-width: 3.5; opacity: 1; }
        }
        .celebrate-line {
            animation: celebratePulse 0.6s ease-in-out 3;
        }

        /* --- KONFETI EFEKT --- */
        @keyframes fall {
        to {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
        }
        .confetti {
        border-radius: 50%;
        opacity: 0.9;
        }

        .source-text {
        display: block;
        text-align: center;
        font-size: 1rem;
        color: #777;
        margin-top: 10px;
        }
        .focus-line {
        transition: opacity 0.2s ease;
        }

        .focus-dot {
        transition: opacity 0.2s ease;
        }

        .focus-label text {
        font-family: 'Segoe UI', sans-serif;
        }
        
    </style>
</head>
<body>

<div class="youdrawit-container">
    <div class="title-wrapper">
        <h2>Kdo jak rychle bohatne?</h2>
        <p class="chart-subtitle">HDP na obyvatele (v¬†tis.¬†USD)</p>
    </div>

    <svg id="guess-chart" viewBox="0 0 620 520" preserveAspectRatio="xMinYMin meet" width="100%" height="100%"></svg>

    <div id="result-box"></div> 
    
    <div class="guess-prompt">
    Jak√° zemƒõ se skr√Ωv√° pod <span class="highlighted">ƒçervenou linkou?</span>
    </div>

    <div class="guess-form">
        <div class="autocomplete-wrapper input-desktop">
            <input 
                type="text" 
                id="country-input" 
                placeholder="üîç Zadej n√°zev zemƒõ" 
                autocomplete="off"
            >
            <div id="custom-suggestions" class="country-suggestions"></div>
        </div>
        
        <datalist id="country-suggestions"></datalist>

        <select id="country-select" class="select-mobile">
            <option value="" disabled selected hidden>üîç Vyber zemi</option>
        </select>

        <button id="guess-button">H√°dej 1/5</button>
    </div>

    <!-- ‚≠êÔ∏è TADY MUS√ç B√ùT TEN PRVEK ‚≠êÔ∏è -->
    <div id="guess-list"></div>



<script>
    (function() {
        const parseDate = d3.timeParse("%Y"); 
        const MAX_GUESSES = 5;
        let guessesMade = 0;
        let gameOver = false;
        
        const d3Colors = ["#007bff", "#28a745", "#ffc107", "#6f42c1","#FF3BF2"]; // Modr√°, zelen√°, ≈ælut√°, fialov√°
        const guessColors = d3.scaleOrdinal(d3Colors);
        const HIGHLIGHT_COLOR = "#f7483b"; 

        // üåç URL datov√©ho souboru na GitHubu
        const DATA_URL = "https://raw.githubusercontent.com/bi-cnc/Hadaci_graf_HDP_na_osobu_data/main/hdp.json";

        const CORRECT_COUNTRY = 'Singapur';
        const CORRECT_EXPLANATION = `
            Ekonomick√Ω p≈ô√≠bƒõh Singapuru pat≈ô√≠ mezi nej√∫spƒõ≈°nƒõj≈°√≠ v modern√≠ historii. Po z√≠sk√°n√≠ nez√°vislosti v roce
             1965 ƒçelil mƒõstsk√Ω st√°t vysok√© nezamƒõstnanosti a nedostatku zdroj≈Ø. Vl√°da Lee Kuan Yewa v≈°ak zvolila 
             strategii p≈ôil√°k√°n√≠ zahraniƒçn√≠ch investic pomoc√≠ n√≠zk√Ωch dan√≠, pr√°vn√≠ stability a nulov√© tolerance ke korupci. 
             D√≠ky strategick√© poloze se stal kl√≠ƒçov√Ωm logistick√Ωm uzlem a investicemi do vzdƒõl√°n√≠ vytvo≈ôil kvalifikovanou pracovn√≠ s√≠lu.
              Singapur se tak promƒõnil z pr≈Ømyslov√© z√°kladny v glob√°ln√≠ centrum financ√≠, technologi√≠ a slu≈æeb, co≈æ vedlo k 
              prudk√©mu r≈Østu bohatstv√≠.
            <br><br>
            <span class="source-text">Zdroj dat: Svƒõtov√° banka</span>
        `;

        // üóÇÔ∏è Naƒçten√° data
        let ALL_DATA_JSON = [];
        let countryNames = [];

        // --- Z√ÅKLADN√ç NASTAVEN√ç GRAFU ---
        let margin = { top: 30, right: 30, bottom: 60, left: 60 };
        let width, height, svgGroup, x, y;
        
        const getCountryData = (countryName) => ALL_DATA_JSON.find(d => d.country === countryName);

        // üåê Naƒçten√≠ dat z GitHubu
        fetch(DATA_URL)
            .then(response => {
                if (!response.ok) throw new Error("Nepoda≈ôilo se naƒç√≠st data.");
                return response.json();
            })
            .then(data => {
                ALL_DATA_JSON = data;
                countryNames = data.map(d => d.country);
                initializeGame(); // üöÄ Spu≈°tƒõn√≠ po naƒçten√≠ dat
            })
            .catch(error => {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat:", error);
                alert("Nepoda≈ôilo se naƒç√≠st data. Zkontroluj p≈ôipojen√≠ nebo URL.");
            });

        
        function drawChart() {
            const svgElement = document.getElementById("guess-chart");
            d3.select(svgElement).selectAll("*").remove();

            const currentSvgWidth = svgElement.getBoundingClientRect().width;
            width = currentSvgWidth - margin.left - margin.right;
            let heightRatio = window.innerWidth < 500 ? 1.7 : 0.9;
            height = (currentSvgWidth * heightRatio) - margin.top - margin.bottom;

            d3.select(svgElement)
                .attr("viewBox", `0 0 ${currentSvgWidth} ${currentSvgWidth * heightRatio}`)
                .attr("preserveAspectRatio", "xMinYMin meet");

            svgGroup = d3.select(svgElement)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // üõ†Ô∏è OPRAVA OSY X: Dynamick√° zmƒõna intervalu tick≈Ø
            const tickInterval = window.innerWidth < 450 
                                ? d3.timeYear.every(10) // Mobily (pod 450px): Zobrazit jen ka≈æd√Ωch 10 let
                                : d3.timeYear.every(5); // V≈°e ostatn√≠: Zobrazit ka≈æd√Ωch 5 let

            // --- Osy ---
            x = d3.scaleTime()
                .domain([parseDate(1990), parseDate(2025)])
                .range([0, width]);

            y = d3.scaleLinear()
                .domain([0, 150000])
                .range([height, 0]);

            const yAxisFormat = d => `${(d / 1000).toFixed(0)} tis. USD`;

            svgGroup.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(
                    d3.axisBottom(x)
                        .tickFormat(d3.timeFormat("%Y"))
                        .ticks(tickInterval)
                ) // üëà ≈æ√°dn√Ω st≈ôedn√≠k tady!
                .selectAll("text")
                .style("font-size", "17px")    /* üëà OPRAVENO */
                .style("font-weight", "500");

            
            // üéØ Definuj konkr√©tn√≠ hodnoty pro osu i grid
            const yTickValues = [0, 20000, 40000, 60000, 80000, 100000, 120000, 140000];

            // üß≠ Osa Y s pevnƒõ dan√Ωmi hodnotami
            svgGroup.append("g")
                .attr("class", "y-axis")   // üëà DOPLNIT
                .call(
                    d3.axisLeft(y)
                    .tickValues(yTickValues)
                    .tickFormat(d => `${(d / 1000).toFixed(0)} tis.`)
                )
            .selectAll("text")
            .attr("dx", "-6") // ‚Üê jemn√Ω posun doleva (vƒõt≈°√≠ mezera)
            .style("font-size", "16px")    /* üëà ZVƒöT≈†IT TOTO */
            .style("font-weight", "500");
            
            // ‚öôÔ∏è Grid ‚Äî sladƒõn√Ω s osou Y
            svgGroup.append("g")
            .attr("class", "y-grid")
            .call(
                d3.axisLeft(y)
                .tickValues(yTickValues)
                .tickSize(-width)  // ƒç√°ry p≈ôes cel√Ω graf
                .tickFormat("")    // bez popisk≈Ø
            )
            .selectAll("line")
            .attr("stroke", "#eee")
            .attr("stroke-dasharray", "3,3");

            // Odstran√≠me obrys (svislou ƒç√°ru vlevo)
            svgGroup.selectAll(".y-grid path").remove();


            // --- Line generator s plynulej≈°√≠ k≈ôivkou ---
            const line = d3.line()
                .x(d => x(parseDate(d.Rok)))
                .y(d => y(d.Hodnota))
                .defined(d => d.Hodnota !== null)
                .curve(d3.curveCatmullRom.alpha(0.5)); // jemnƒõj≈°√≠ pr≈Øbƒõh

            // --- ü©∂ ≈†ed√© linky v≈°ech ostatn√≠ch zem√≠ ---
            ALL_DATA_JSON.forEach(d => {
                if (d.country !== CORRECT_COUNTRY) {
                    svgGroup.append("path")
                        .datum(d.data)
                        .attr("class", "country-line")
                        .attr("d", line)
                        .attr("stroke", "#363433")     // tmav≈°√≠ ≈°ed√°
                        .attr("stroke-width", 2.4)     // silnƒõj≈°√≠
                        .attr("fill", "none")
                        .attr("opacity", 0.85);        // dob≈ôe viditeln√©
                }
            });


// --- ‚ù§Ô∏è ƒåerven√° animovan√° mystery line s diagon√°ln√≠m gradientem ---
            const mysteryData = getCountryData(CORRECT_COUNTRY).data;
            const lastPoint = mysteryData[mysteryData.length - 1];

            // üé® Definice gradientu
            const gradient = svgGroup.append("defs")
            .append("linearGradient")
            .attr("id", "redGradient")
            .attr("x1", "0%")
            .attr("y1", "100%")
            .attr("x2", "100%")
            .attr("y2", "0%");

            gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#f86a5f");
            gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#f7483b");

            // üí´ Definice jemn√©ho st√≠nu
            const filter = svgGroup.select("defs")
            .append("filter")
            .attr("id", "softShadow")
            .attr("x", "-20%")
            .attr("y", "-20%")
            .attr("width", "150%")
            .attr("height", "150%");

            filter.append("feDropShadow")
            .attr("dx", 0.8)     // posun st√≠nu na X
            .attr("dy", 1.2)     // posun na Y
            .attr("stdDeviation", 1.2)  // rozmaz√°n√≠
            .attr("flood-color", "#000")
            .attr("flood-opacity", 0.25);

            // üü• ƒåerven√° ƒç√°ra s p≈ôechodem
            const redPath = svgGroup.append("path")
            .datum(mysteryData)
            .attr("class", "mystery-line")
            .attr("stroke", "url(#redGradient)")
            .attr("fill", "none")
            .attr("stroke-width", 3.5)
            .attr("filter", "url(#softShadow)")  // üåü pou≈æije st√≠n
            .attr("d", line);

            // üß≠ Tooltip container
            const tooltip = d3.select(".youdrawit-container")
            .append("div")
            .attr("class", "tooltip")
            .style("position", "absolute")
            .style("background", "white")
            .style("border", "1px solid #ddd")
            .style("border-radius", "6px")
            .style("padding", "6px 10px")
            .style("font-size", "13px")
            .style("color", "#333")
            .style("box-shadow", "0 2px 8px rgba(0,0,0,0.1)")
            .style("pointer-events", "none")
            .style("opacity", 0);

            // üü¢ Overlay pro interakci (neviditeln√Ω, ale zachyt√°v√° pohyb my≈°i)
            svgGroup.append("rect")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mousemove", (event) => {
                const [mouseX] = d3.pointer(event);
                const bisect = d3.bisector(d => parseDate(d.Rok)).left;
                const x0 = x.invert(mouseX);
                const i = bisect(mysteryData, x0, 1);
                const d0 = mysteryData[i - 1];
                const d1 = mysteryData[i];
                const d = x0 - parseDate(d0.Rok) > parseDate(d1.Rok) - x0 ? d1 : d0;

                tooltip.transition().duration(100).style("opacity", 1);
                tooltip.html(`
                    <strong>${d.Rok}</strong><br>
                    ${d.Hodnota.toLocaleString("cs-CZ")} USD
                `)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseleave", () => {
                tooltip.transition().duration(200).style("opacity", 0);
            });

            const totalLength = redPath.node().getTotalLength();

            redPath
                .attr("stroke-dasharray", `${totalLength} ${totalLength}`)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(2500)
                .ease(d3.easeCubicOut)
                .attr("stroke-dashoffset", 0);

            // --- ‚ú® Po dokonƒçen√≠ animace p≈ôidat label a teƒçku ---
            redPath.transition().delay(2500).on("end", () => {
                svgGroup.append("text")
                    .attr("x", x(parseDate(lastPoint.Rok)) + 8)
                    .attr("y", y(lastPoint.Hodnota) + 5)
                    .attr("text-anchor", "start")
                    .style("fill", HIGHLIGHT_COLOR)
                    .style("font-size", "20px")  // üëà zvƒõt≈°en√≠ otazn√≠ku
                    .attr("class", "label-text mystery-question")
                    .text("?");

                svgGroup.append("circle")
                    .attr("cx", x(parseDate(lastPoint.Rok)))
                    .attr("cy", y(lastPoint.Hodnota))
                    .attr("r", 5)
                    .attr("class", "country-dot")
                    .style("fill", HIGHLIGHT_COLOR);
            });
            // üü° Tooltip pro ƒçervenou linku ve stylu Our World in Data
            const focusLine = svgGroup.append("line")
            .attr("class", "focus-line")
            .attr("stroke", "#999")
            .attr("stroke-dasharray", "3,3")
            .attr("stroke-width", 1)
            .style("opacity", 0);

            const focusDot = svgGroup.append("circle")
            .attr("class", "focus-dot")
            .attr("r", 5)
            .attr("fill", HIGHLIGHT_COLOR)
            .attr("stroke", "#fff")
            .attr("stroke-width", 2)
            .style("opacity", 0);

            const focusLabel = svgGroup.append("g")
            .attr("class", "focus-label")
            .style("opacity", 0);

            focusLabel.append("rect")
                .attr("rx", 6)
                .attr("ry", 6)
                .attr("fill", "rgba(255, 255, 255, 0.85)")  // üîπ polopr≈Øhledn√© b√≠l√© pozad√≠
                .attr("stroke", "none")                      // üîπ bez ƒçerven√©ho r√°meƒçku
                .attr("height", 28)
                .attr("width", 64)
                .attr("y", -20)
                .attr("x", 10)
                .style("filter", "drop-shadow(0px 1px 2px rgba(0,0,0,0.15))");

            focusLabel.append("text")
                .attr("x", 42)
                .attr("y", -4)
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .attr("fill", HIGHLIGHT_COLOR)   // z≈Øst√°v√° ƒçerven√Ω text
                .attr("font-weight", "700")
                .attr("font-size", "13px");

            // üéØ Overlay pro interakci
            svgGroup.append("rect")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all")
            .on("mousemove", (event) => {
                const [mouseX] = d3.pointer(event);
                const bisect = d3.bisector(d => parseDate(d.Rok)).left;
                const x0 = x.invert(mouseX);
                const i = bisect(mysteryData, x0, 1);
                const d0 = mysteryData[i - 1];
                const d1 = mysteryData[i];
                const d = x0 - parseDate(d0.Rok) > parseDate(d1.Rok) - x0 ? d1 : d0;

                // Aktualizuj prvky
                focusLine
                    .attr("x1", x(parseDate(d.Rok)))
                    .attr("x2", x(parseDate(d.Rok)))
                    .attr("y1", 0)
                    .attr("y2", height)
                    .style("opacity", 0.5);

                focusDot
                    .attr("cx", x(parseDate(d.Rok)))
                    .attr("cy", y(d.Hodnota))
                    .style("opacity", 1);

                focusLabel
                    .attr("transform", `translate(${x(parseDate(d.Rok))},${y(d.Hodnota)})`)
                    .style("opacity", 1);
                
                focusLabel.select("text")
                    .text(`${(d.Hodnota / 1000).toFixed(1).replace('.', ',')} tis.`);
            })
            .on("mouseleave", () => {
                focusLine.style("opacity", 0);
                focusDot.style("opacity", 0);
                focusLabel.style("opacity", 0);
            });

        }

        
        // --- FUNKCE PRO INTERAKCI ---
        
        let guessList = [];

        function updateGuessList() {
             const guessListDiv = d3.select("#guess-list");
             guessListDiv.selectAll("*").remove();
             
             if (guessesMade > 0) {
                 guessList.slice().reverse().forEach((guess, index) => {
                     const originalIndex = guessesMade - 1 - index; 
                     const color = guess.correct ? HIGHLIGHT_COLOR : guessColors(originalIndex);
                     
                     guessListDiv.append("div")
                         .attr("class", "guess-item")
                         .style("border-left", `5px solid ${color}`)
                         .html(`<span>${originalIndex + 1}. ${guess.country}</span>
                                  <span style="color: ${color};">${guess.correct ? "‚úì Spr√°vnƒõ!" : "‚úï ≈†patnƒõ"}</span>`);
                 });
             }
        }
        
        function drawGuessLine(countryName, isCorrect) {
            const data = getCountryData(countryName).data;
            const color = isCorrect ? HIGHLIGHT_COLOR : guessColors(guessesMade - 1);

            const line = d3.line()
                .x(d => x(parseDate(d.Rok)))
                .y(d => y(d.Hodnota))
                .defined(d => d.Hodnota !== null)
                .curve(d3.curveCatmullRom.alpha(0.5)); // plynul√© k≈ôivky, stejn√© jako hlavn√≠

            // ü©µ Jemnƒõj≈°√≠ ƒç√°ra pro tipy
            const path = svgGroup.append("path")
                .datum(data)
                .attr("class", "guessed-line")
                .attr("fill", "none")
                .attr("stroke", color)
                .attr("stroke-width", isCorrect ? 3.5 : 1.8) // ƒçerven√° silnƒõj≈°√≠, ostatn√≠ jemnƒõj≈°√≠
                .attr("opacity", isCorrect ? 0.95 : 0.8)
                .attr("d", line);

            // ‚ú® Animace vykreslen√≠
            const totalLength = path.node().getTotalLength();
            path
                .attr("stroke-dasharray", `${totalLength} ${totalLength}`)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(1800)
                .ease(d3.easeCubicOut)
                .attr("stroke-dashoffset", 0);

            // üü¢ Po animaci p≈ôidej teƒçku a zkratku zemƒõ ‚Äì spr√°vnƒõ podle dat a s chytr√Ωm posouv√°n√≠m
            
            // üéØ OPRAVA: Najdeme posledn√≠ bod, kter√Ω m√° platnou hodnotu (nen√≠ null ani undefined)
            // Pou≈æ√≠v√°me (d.Hodnota != null), co≈æ zachyt√≠ oboj√≠.
            const validData = data.filter(d => d.Hodnota != null);
            const lastPoint = validData.length > 0 ? validData[validData.length - 1] : null;

            path.transition().delay(1800).on("end", () => {

                        // üõë Pojistka: Pokud pro zemi neexistuje ≈æ√°dn√Ω platn√Ω bod, nic nekresli
                        if (!lastPoint) return; 

            if (!window.usedLabelPositions) window.usedLabelPositions = [];

            const xPos = x(parseDate(lastPoint.Rok));
            const yPos = y(lastPoint.Hodnota);
            let labelY = yPos + 5;
            const minDistance = 10;
            const chartBottom = y(0) - 10;
            const chartTop = 10;

            // Najdi nejbli≈æ≈°√≠ popisek a pokud koliduje, posu≈à nahoru nebo dol≈Ø
            let attempts = 0;
            while (
                window.usedLabelPositions.some(pos => Math.abs(pos.y - labelY) < minDistance) &&
                attempts < 10
            ) {
                labelY += (attempts % 2 === 0 ? -1 : 1) * minDistance; // st≈ô√≠davƒõ nahoru/dol≈Ø
                attempts++;
            }

            // Zajisti, ≈æe label z≈Østane uvnit≈ô grafu
            labelY = Math.max(chartTop, Math.min(chartBottom, labelY));

            // Pokud u≈æ fakt nen√≠ m√≠sto ‚Üí posu≈à trochu v√≠c doprava
            const collision = window.usedLabelPositions.some(pos => Math.abs(pos.y - labelY) < minDistance);
            const xOffset = collision ? 40 : 10; // üëâ pokud kolize p≈ôetrv√°, label jde v√≠c vpravo

            // Ulo≈æ pozici
            window.usedLabelPositions.push({ y: labelY, xOffset });

            // üîµ Teƒçka z≈Øst√°v√° p≈ôesnƒõ na konci linky podle dat
            svgGroup.append("circle")
                .attr("cx", xPos)
                .attr("cy", yPos)
                .attr("r", isCorrect ? 5 : 4)
                .attr("class", "country-dot")
                .style("fill", color);

            if (!isCorrect) {
                svgGroup.append("text")
                    .attr("x", xPos + xOffset)
                    .attr("y", labelY)
                    .attr("text-anchor", "start")
                    .attr("class", "label-text")
                    .style("fill", color)
                    .style("font-size", "12px")
                    .text(countryName.substring(0, 3).toUpperCase());
            }
        });

        }


        // üèÜ UPRAVEN√Å FUNKCE endGame() PRO POU≈ΩIT√ç #result-box
        function endGame(won) {
            gameOver = true;

            // --- SMAZAT OT√ÅZN√çK A TEƒåKU ---
            svgGroup.selectAll(".mystery-question").remove();  // otazn√≠k
            svgGroup.selectAll(".country-dot").remove();       // p≈Øvodn√≠ teƒçka na konci linky
            svgGroup.selectAll(".mystery-label").remove();     // star√© labely
            svgGroup.selectAll(".mystery-dot").remove();       // star√© teƒçky

            // --- Nahrazen√≠ otazn√≠ku za zkratku zemƒõ ---
            try {
                const correctData = getCountryData(CORRECT_COUNTRY).data;
                const lastValid = correctData.filter(d => d.Hodnota != null).pop();

                const xPos = x(parseDate(lastValid.Rok));
                const yPos = y(lastValid.Hodnota);

                // Nov√° teƒçka
                svgGroup.append("circle")
                    .attr("cx", xPos)
                    .attr("cy", yPos)
                    .attr("r", 5)
                    .attr("class", "mystery-dot")
                    .style("fill", HIGHLIGHT_COLOR);

                // T≈ô√≠p√≠smenn√° zkratka zemƒõ
                svgGroup.append("text")
                    .attr("x", xPos + 8)
                    .attr("y", yPos + 5)
                    .attr("text-anchor", "start")
                    .attr("class", "mystery-label label-text")
                    .style("fill", HIGHLIGHT_COLOR)
                    .style("font-size", "14px")
                    .text(CORRECT_COUNTRY.substring(0, 3).toUpperCase());

            } catch (e) {
                console.warn("Label replace failed:", e);
            }

            d3.select("#guess-button").attr("disabled", true).text("Konec hry");
            d3.select("#country-input").attr("disabled", true).property("value", "");
            d3.select("#country-select").attr("disabled", true);

            const resultBox = document.getElementById("result-box");
            let contentHTML = "";

            if (won) {
                d3.select(".mystery-line").classed("celebrate-line", true);

                // (konfety beze zmƒõny)
                for (let i = 0; i < 80; i++) {
                    const confetti = document.createElement("div");
                    confetti.classList.add("confetti");
                    document.body.appendChild(confetti);

                    const size = Math.random() * 6 + 4;
                    const left = Math.random() * window.innerWidth;
                    const hue = Math.random() * 360;
                    const duration = Math.random() * 1.5 + 1.5;

                    confetti.style.width = `${size}px`;
                    confetti.style.height = `${size}px`;
                    confetti.style.left = `${left}px`;
                    confetti.style.backgroundColor = `hsl(${hue}, 80%, 60%)`;
                    confetti.style.animation = `fall ${duration}s ease-out forwards`;
                    confetti.style.position = "fixed";
                    confetti.style.top = "-10px";
                    confetti.style.zIndex = 9999;

                    setTimeout(() => confetti.remove(), duration * 1000);
                }

                contentHTML = `
                    <h3>üéâ Trefil jsi to! üéâ</h3>
                    <p>Spr√°vn√° odpovƒõƒè byla <span class="correct-answer">${CORRECT_COUNTRY}</span>.</p>
                    <br>
                    <p>${CORRECT_EXPLANATION}</p>
                    <button id="new-game-button-result" 
                        onclick="window.initializeGame();">
                        Nov√° hra
                    </button>
                `;
            } else {
                const isCorrectGuessed = guessList.some(g => g.country === CORRECT_COUNTRY && g.correct);
                if (!isCorrectGuessed) drawGuessLine(CORRECT_COUNTRY, true);

                contentHTML = `
                    <h3>‚ùå  Bohu≈æel, dneska to nevy≈°lo...</h3>
                    <p>Spr√°vn√° odpovƒõƒè byla <span class="correct-answer">${CORRECT_COUNTRY}</span>.</p>
                    <br>
                    <p>${CORRECT_EXPLANATION}</p>
                    <button id="new-game-button-result" 
                        onclick="window.initializeGame();">
                        Zkus znovu
                    </button>
                `;
            }

            resultBox.innerHTML = contentHTML;
            resultBox.style.display = "block";
        }


        
        function handleGuess() {
            if (gameOver) return;

            let guessedCountry = document.getElementById("country-input").value.trim();
            if (!guessedCountry) return;

            // ‚≠êÔ∏è NORMALIZACE
            let normalized = countryNames.find(
                c => c.toLowerCase() === guessedCountry.toLowerCase()
            );

            if (!normalized) {
                normalized = countryNames.find(
                    c => c.toLowerCase().startsWith(guessedCountry.toLowerCase())
                );
            }

            if (normalized) guessedCountry = normalized;

            // ‚≠êÔ∏è NAJDI ZEMI V DATECH
            const countryMatch = ALL_DATA_JSON.find(
                d => d.country.toLowerCase() === guessedCountry.toLowerCase()
            );

            if (!countryMatch) {
                alert("Pros√≠m zadej platnou zemi ze seznamu.");
                return;
            }

            // ‚≠êÔ∏è DUPLICITA ‚Äî TEPRVE TEƒé, kdy≈æ existuje countryMatch
            if (guessList.some(g => g.country.toLowerCase() === countryMatch.country.toLowerCase())) {
                alert("Tuto zemi jsi ji≈æ h√°dal. Zkus jinou.");
                return;
            }

            // üîç Vyhodnocen√≠ tipu
            const isCorrect = countryMatch.country === CORRECT_COUNTRY;
            guessesMade++;
            guessList.push({ country: countryMatch.country, correct: isCorrect });

            if (!isCorrect) {
                drawGuessLine(countryMatch.country, false);
            }

            updateGuessList();

            // üéØ V√Ωsledek
            if (isCorrect) {
                endGame(true);
            } else if (guessesMade >= MAX_GUESSES) {
                endGame(false);
            } else {
                d3.select("#guess-button").text(`H√°dej ${guessesMade + 1}/${MAX_GUESSES}`);
            }

            // üßπ Reset inputu
            document.getElementById("country-input").value = "";

            // Skryjeme na≈°ept√°vaƒç
            d3.select("#custom-suggestions").style("display", "none");
        }


        // Nov√° funkce pro filtrov√°n√≠ a zobrazen√≠ n√°vrh≈Ø
        function showSuggestions(inputValue) {
            const suggestionsContainer = d3.select("#custom-suggestions");
            suggestionsContainer.html(""); // Vyƒçistit star√© n√°vrhy
            
            // Zobraz√≠me, jen pokud je vstup del≈°√≠ ne≈æ 0
            if (inputValue.length === 0) {
                suggestionsContainer.style("display", "none");
                return;
            }

            const valueLower = inputValue.toLowerCase().trim();
            
            // üéØ FILTR: Zemƒõ, jej√≠≈æ n√°zev ZAƒå√çN√Å na zadan√Ω text
            const filteredCountries = countryNames.filter(country => 
                country.toLowerCase().startsWith(valueLower)
            );
            
            if (filteredCountries.length === 0) {
                suggestionsContainer.style("display", "none");
                return;
            }

            // Vytvo≈ôen√≠ element≈Ø pro n√°vrhy
            filteredCountries.forEach(country => {
                const item = suggestionsContainer.append("div")
                    .attr("class", "suggestion-item")
                    .attr("data-country", country);
                    
                // Logika pro zv√Ωraznƒõn√≠ shody
                const matchLength = inputValue.length;
                const matchText = country.substring(0, matchLength);
                const remainingText = country.substring(matchLength);
                
                item.html(`<span class="match">${matchText}</span>${remainingText}`);

                // Kliknut√≠ na n√°vrh: vypln√≠ input a skryje box
                item.on("click", function() {
                    const country = d3.select(this).attr("data-country");
                    document.getElementById("country-input").value = country;
                    suggestionsContainer.style("display", "none");
                });
            });

            suggestionsContainer.style("display", "block");
        }

        // --- INICIALIZACE HRY ---
        function initializeGame() {
            guessesMade = 0;
            gameOver = false;
            guessList = [];
            window.usedLabelPositions = [];
            
            // Reset prvk≈Ø
            d3.select("#result-box").style("display", "none").html(""); 
            d3.select("#guess-button").attr("disabled", null).text(`H√°dej 1/${MAX_GUESSES}`);
            d3.select("#country-input").attr("disabled", null).property("value", ""); 
            
            // ‚ùå TOTO JE ODSTRANƒöNO: d3.select("#country-select").attr("disabled", null).property("value", ""); 
            // ‚ùå TENTO K√ìD PRO NAPLNƒöN√ç SELECTU JE NYN√ç ODSTRANƒöN, PONECH√ÅV√ÅME JEN RESET SELECTU, POKUD JE POT≈òEBA Z HTML:
            /* const sortedCountries = countryNames.slice().sort((a, b) =>
                a.localeCompare(b, "cs", { sensitivity: "base" })
            );
            const select = d3.select("#country-select");
            select.selectAll("option:not([disabled])").remove();
            sortedCountries.forEach(country => {
                select.append("option").attr("value", country).text(country);
            }); 
            */
            
            d3.select("#guess-list").selectAll("*").remove(); 

            drawChart();
            
            d3.select("#guess-button").on("click", handleGuess);
            
        // üéØ LOGIKA PRO VLASTN√ç NA≈†EPTV√Åƒå (NYN√ç PRO V≈†ECHNY VELIKOSTI)
            const countryInput = document.getElementById("country-input");
            const suggestionsBox = d3.select("#custom-suggestions");
            
            // 1. Odstranƒõn√≠ star√©ho list atributu
            countryInput.removeAttribute("list"); 

            // 2. Trval√Ω posluchaƒç pro psan√≠ (BEZ KONTROLY ≈†√ç≈òKY)
            countryInput.addEventListener("input", () => {
                showSuggestions(countryInput.value);
            });
            
            // 3. Posluchaƒç pro zav≈ôen√≠ na≈°ept√°vaƒçe po kliknut√≠ mimo nƒõj
            document.addEventListener("click", function(event) {
                const wrapper = document.querySelector(".autocomplete-wrapper");
                if (wrapper && !wrapper.contains(event.target)) {
                    suggestionsBox.style("display", "none");
                }
            });

            d3.select("#country-input").on("keydown", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault(); 
                    handleGuess();
                    suggestionsBox.style("display", "none");
                }
            });
        }
        
        // Zp≈ô√≠stupn√≠me funkci initializeGame glob√°lnƒõ, aby ji vidƒõlo tlaƒç√≠tko "Nov√° hra"
        window.initializeGame = initializeGame;
        
        window.addEventListener("load", () => {
            requestAnimationFrame(() => {
                initializeGame();      // 1. vykreslen√≠
                setTimeout(() => {
                    drawChart();       // 2. korekƒçn√≠ vykreslen√≠
                }, 200);
            });
        });

    })();
</script>
</body>
</html>
